<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<style>
    .container {
        width: 650px;
        height: 500px;
        margin: auto;
    }
    .aside {
        width: 150px;
        height: 100%;
        background-color: aliceblue;
        float: left;
    }
    .aside input{
        width: 90%;
    }
    .aside button {
        width: 40%;
    }
    .content {
        width: 500px;
        height: 100%;
        background-color: azure;
        float: right;
    }
</style>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>
	// 목록을 출력하는 작업은 꼭 등록할 때만이 아니라, 유저가 처음 브라우저로 main.html 요청한 시점부터도 목록이 나오는 등
	// 목록 기능은 재사용 가능성이 높다. 따라서 함수로 별도로 정의.
	function printList(list) {
		console.log("전달받은 배열은", list);
		
		// 렌더링 작업은 고되고 시간이 오래 걸린다. 따라서 Vue나 React.js 로 진행
		// document.querySelector(".content").innerHTML="<table>";
		let tag="<table width = '100%' border = '1px'>";
		tag += "<thead>";
		
		tag += "<tr>";
		tag += "<th>아이디</th>";
		tag += "<th>이름</th>";
		tag += "<th>이메일</th>";
		tag += "</tr>";
		
		tag += "</thead>";
		
		tag += "</tbody>";
		
		for(let i = 0; i<list.length; i++) {
			let member = list[i];
			tag += "<tr>";
			tag += "<td>"+member.id+"</td>";
			tag += "<td>"+member.name+"</td>";
			tag += "<td>"+member.email+"</td>";
			tag += "</tr>";
		}
		tag += "</tbody>";
		tag += "</table>";
		
		$(".content").html(tag);
	}
	
	// 서버에 목록 요청(비동기적)
	function getList() {
		// 비동기적 요청을 담당하는 XMLHttpRequest 객체를 사용
		let xhttp = new XMLHttpRequest();
		
		// 서버의 응답이 도달하면 지정한 익명함수가 호출(by javascript)
		xhttp.onload=function() {
			
			// 서버에서 전송한 json 문자열을 파싱하여 화면에 렌더링
			console.log("서버가 응답한 데이터는 ", this.responseText);
			let memberList =JSON.parse(this.responseText);		// 파싱 반드시 문자열이 jSON 표기법을 따른 것만이 파싱에 성고할 수 있따
			
			printList(memberList);
			// 화면에 렌더링}
		}
		xhttp.open("GET", "/ajax/async_list.jsp");	  // 요청준비
		xhttp.send();	// 여기서 요청 발생
	}
	
	function regist() {
		let xhttp = new XMLHttpRequest();   // js의 비동기 통신 객체
		
		xhttp.onload = function() {
			// 서버에서 응답 정보가 도착하면 호출되는 익명함수. 역할로서는 콜백함수
			// console.log("서버에서 보내온 데이터는 ", this.responseText);
			
			// 받아온 데이터는 언제나 문자열이므로, oop식으로 제어하려면 파싱하면 된다.
			// let memberList= JSON.parse(this.responseText);
			// console.log(memberList);
			// 서버에서 가져온 데이터를 화면에 출력
			// getList(memberList);
			console.log("등록 완료");
			
			getList();
		}
		
		
        xhttp.open("POST", "/ajax/async_regist.jsp");    // 요청 방법 및 요청 주소 지정
        xhttp.setRequestHeader("Content-Type", "application/x-www-form-urlencoded; charset-utf-8")  // 전송시 헤더 지정
        xhttp.send("id=" + $("input[name='id']").val() + "&name=" + $("input[name='name']").val() + "&email=" + $("input[name='email']").val());	// 요청 시작
        // 비동기 요청 출발. 이 때, 요청 시도 자체를 js 가 하지 않고 브라우저에게 시킨다
        // js는 응답 정보가 올 때까지 대기상태가 되는 게 아니라, 다른 일을 할 수 있다(비동기 방식)
        // 응답이 올 때까지 기다리지 않기 때문에 순서가 없는 것.
        // 브라우저가 응답을 받으면, js에게 알린다. 이 때 js의 XMLHttpRequest의 onload 속성에 지정한 익명함수인 콜백함수 호출.(누가? js가)
	}


	$(()=>{
		$("button").click(()=>{
			regist();
		});
		
		// 문서가 로드되면 기존에 누적된 데이터를 비동기적으로 가져오자
		getList();
	});
</script>
</head>
<body>
    <div class="container">
        <div class="aside">
            <form>
                <input type="text" placeholder="아이디" name="id">
                <input type="text" placeholder="이름" name="name">
                <input type="text" placeholder="이메일" name="email">
                <button type="button">등록(비동기)</button>
            </form>
        </div>
        <div class="content">
        </div>
    </div>
</body>
</html>